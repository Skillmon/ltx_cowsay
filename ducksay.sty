\RequirePackage{xparse,l3keys2e}

\def\ducksay@version{v0.1b}
\def\ducksay@date{2017/09/21}

\ProvidesExplPackage
  {ducksay}           {\ducksay@date}
  {\ducksay@version}  {cowsay for LaTeX}

\ExplSyntaxOn

\int_new:N \l_ducksay_strlen_int

\cs_new:Npn \ducksay_print:n #1 {%>>>
  \exp_args:NNx \tl_set:Nn \l_tmpa_tl { #1 }
  \regex_replace_all:nnN { \s } { \c{space} } \l_tmpa_tl
  \int_set:Nn \l_ducksay_strlen_int { \tl_count:N \l_tmpa_tl }
  \frenchspacing
  \group_begin:
    \ttfamily
    \begin{tabular}[\l_ducksay_align_tl]{@{}l@{}}
      \ducksay_bubblesize:
      \begin{tabular}{@{}l@{}}
        {\ __\int_step_inline:nnnn{1}{1}{\l_ducksay_strlen_int}{_}}\\\null
        {(\ #1\ )}\\[-1ex]\null
        {\ {-}{-}\int_step_inline:nnnn{1}{1}{\l_ducksay_strlen_int}{{-}}}\\
      \end{tabular}\\\null
      \begin{tabular}{@{}l@{}}
        \l_ducksay_animal_tl
      \end{tabular}
    \end{tabular}
  \group_end:
}%<<<

\NewDocumentCommand{\ducksay}{ O{} m }{%>>>
  \group_begin:
    \keys_set:nn { ducksay } { default_animal,#1 }
    \ducksay_print:n { #2 }
  \group_end:
}%<<<

% regexes for \cowthink >>>
\regex_const:Nn \c_cowsay_first_regex  { \A(.\s*)\\ }
\regex_const:Nn \c_cowsay_second_regex { \A(.[^\c{null}]*\c{null}\s*)\\ }
\regex_const:Nn \c_cowsay_third_regex  {
  \A(.[^\c{null}]*\c{null}[^\c{null}]*\c{null}\s*)\\ }
%<<<

\NewDocumentCommand{\duckthink}{ O{} m }{%>>>
  \group_begin:
    \keys_set:nn { ducksay } { default_animal,#1 }
    \regex_replace_once:NnN \c_cowsay_first_regex  { \1O } \l_ducksay_animal_tl
    \regex_replace_once:NnN \c_cowsay_second_regex { \1o } \l_ducksay_animal_tl
    \regex_replace_once:NnN \c_cowsay_third_regex  { \1o } \l_ducksay_animal_tl
    \ducksay_print:n { #2 }
  \group_end:
}%<<<

\keys_define:nn { ducksay } {%>>>
  ,bubble .code:n    = \cs_set:Nn \ducksay_bubblesize: {#1}
  ,bubble .initial:n = \relax
  ,align  .tl_set:N  = \l_ducksay_align_tl
  ,align  .initial:n = {}
  ,align  .value_required:n = true
  ,animal .code:n    = {
    \keys_define:nn { ducksay } { default_animal .meta:n = {#1} }}
  ,animal .initial:n = duck
}%<<<

\NewDocumentCommand{\DefaultAnimal}{ m }{%>>>
  \keys_define:nn { ducksay } { default_animal .meta:n = {#1} }}%<<<

\NewDocumentCommand{\AddAnimal}{ s m +v }{%>>>
  \tl_set:Nn \l_tmpa_tl { \ #3 }
  \regex_replace_all:nnN { \r } { \c{tabularnewline}\c{null} } \l_tmpa_tl
  \cs_gset_eq:cN { g_ducksay_animal_#2_tl } \l_tmpa_tl
  \keys_define:nn { ducksay } {
    #2 .code:n = \cs_set_eq:Nc \l_ducksay_animal_tl { g_ducksay_animal_#2_tl }
  }
  \IfBooleanT{#1}{
    \keys_define:nn { ducksay } {
      default_animal .meta:n = {#2} }}
}%<<<

\ExplSyntaxOff

% Animals:>>>
% some of the below are from http://ascii.co.uk/art/kangaroo
\AddAnimal{duck}%>>>
{  \
    \   __
      >(' )
        )/
       /(
      /  `----/
      \  ~=- /
    ~^~^~^~^~^~^~^}%<<<
\AddAnimal{small-duck}%>>>
{  \
    \
      >()_
       (__)__ _}%<<<
\AddAnimal{duck-family}%>>>
{  \
    \   __
      >(' )
        )/
       /(
      /  `----/  -()_  >()_
    __\__~=-_/__ _(__)__(__)__ _}%<<<
\AddAnimal{cow}%>>>
{  \  ^__^
    \ (oo)\_______
      (__)\       )\/\
          ||----w |
          ||     ||}%<<<
\AddAnimal{head-in}%>>>
{  \  
    \ ^__^         /
      (oo)\_______/  ________
      (__)\       )=(  ___|_ \____
          ||----w |  \ \    \____ |
          ||     ||   ||         ||}%<<<
\AddAnimal{tux}%>>>
{  \
    \  .--. 
      |o_o |
      |\_/ |
     //   \ \
    (|     | )
   /'\_   _/`\
   \___)=(___/}%<<<
\AddAnimal{pig}%>>>
+  \     _//| .-~~~-.
    \ _/oo  }       }-@
     ('')_  }       |
      `--'| { }--{  }
           //_/  /_/+%<<<
\AddAnimal{frog}%>>>
{   \
     \ (.)_(.)
    _ (   _   ) _
   / \/`-----'\/ \
 __\ ( (     ) ) /__
 )   /\ \._./ /\   (
  )_/ /|\   /|\ \_(}%<<<
\AddAnimal{snowman}%>>>
{  \
    \_[_]_
      (")
   >-( : )-<
    (__:__)}%<<<
\AddAnimal{hedgehog}%>>>
{  \    .\|//||\||.
    \  |/\/||/|//|/|
      /. `|/\\|/||/||
     o__,_|//|/||\||'}%<<<
\AddAnimal{kangaroo}%>>>
{  \
    \ _,'   ___
     <__\__/   \
        \_  /  _\
          \,\ / \\
            //   \\
          ,/'     `\_,}%<<<

% from http://www.ascii-art.de/ascii/s/starwars.txt :
\AddAnimal{yoda}%>>>
{   \
     \             ____
      \         _.' :  `._
            .-.'`.  ;   .'`.-.
   __      / : ___\ ;  /___ ; \      __
 ,'_ ""--.:__;".-.";: :".-.":__;.--"" _`,
 :' `.t""--.. '<@.`;_  ',@>` ..--""j.' `;
      `:-.._J '-.-'L__ `-- ' L_..-;'
        "-.__ ;  .-"  "-.  : __.-"
            L ' /.------.\ ' J
             "-.   "--"   .-"
            __.l"-:_JL_;-";.__
         .-j/'.;  ;""""  / .'\"-.
       .' /:`. :  :     /.".'';  `.
    .-"  / ;`.".  :    ."."   :    "-.
 .+"-.  : :   ".".". ."."      ;-._   \
 ; \  `.; ; .   "."-"."        : : "+. ;
 :  ;   ; ;  .   ."."    ;     : ;  : \:
 ;  :   ; :     / /     /  ,   ;:   ;  :
: \  ;  :  ;   ; /     :  ,   : ;  /  ::
;  ; :   ; :  ; ;      ;      ;   :   ;:
:  :  ;  :  ;. ;      '      : :  ;  : ;
;\    :   ; : .          ,   ; ;     ; ;
: `."-;   :  ;      .   ;   :  ;    /  ;
 ;    -:   ; :      ,  ,    ;  : .-"   :
 :\     \  :  ;    ,       : \.-"      :
  ;`.    \  ; :   .   ,    ;.'_..--  / ;
  :  "-.  "-:  ;     ,    :/."      .'  :
   \         \ :    :     ;/  __        :
    \       .-`.\        /t-""  ":-+.   :
     `.  .-"    `l    __/ /`. :  ; ; \  ;
       \   .-" .-"-.-"  .' .'j \  /   ;/
        \ / .-"   /.     .'.' ;_:'    ;
         :-""-.`./-.'     /    `.___.'
               \ `t  ._  /
                "-.t-._:'}%<<<
\AddAnimal{yoda-head}%>>>
{   \
     \             ____
      \         _.' :  `._
            .-.'`.  ;   .'`.-.
   __      / : ___\ ;  /___ ; \      __
 ,'_ ""--.:__;".-.";: :".-.":__;.--"" _`,
 :' `.t""--.. '<@.`;_  ',@>` ..--""j.' `;
      `:-.._J '-.-'L__ `-- ' L_..-;'
        "-.__ ;  .-"  "-.  : __.-"
            L ' /.------.\ ' J
             "-.   "--"   .-"
            __.l"-:_JL_;-";.__
         .-j/'.;  ;""""  / .'\"-.
       .' /:`. :  :     /.".'';  `.
    .-"  / ;`.".  :    ."."   :    "-.
 .+"-.  : :   ".".". ."."      ;-._   \}%<<<
\AddAnimal{r2d2}%>>>
{  \
    \ ,-----.
    ,'_/_|_\_`.
   /<<::8[O]::>\
  _|-----------|_
 |  | ====-=- |  |
 |  | -=-==== |  |
 \  | ::::|()||  /
  | | ....|()|| |
  | |_________| |
  | |\_______/| |
 /   \ /   \ /   \
 `---' `---' `---'}%<<<
\AddAnimal{vader}%>>>
{  \     _.-'~~~~~~`-._
    \   /      ||      \
       /       ||       \
      |        ||        |
      | _______||_______ |
      |/ ----- \/ ----- \|
     /  (     )  (     )  \
    / \  ----- () -----  / \
   /   \      /||\      /   \
  /     \    /||||\    /     \
 /       \  /||||||\  /       \
/_        \o========o/        _\
  `--...__|`-._  _.-'|__...--'
          |    `'    |}%<<<
%<<<

\ExplSyntaxOn

\ProcessKeysOptions { ducksay }

\keys_define:nn { ducksay } {
  ,animal .undefine:
}

\ExplSyntaxOff

% vim: fdm=marker foldmarker=>>>,<<<
